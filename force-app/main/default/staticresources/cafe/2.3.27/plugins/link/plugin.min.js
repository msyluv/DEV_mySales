/*! cafe note v2.3.27 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("link",["commonformat"],function(a,b){function c(a){ma=a}function d(){return ma}function e(a){na=a}function f(){return na}function g(b){var c,d=a.selectionManager.getCursorPosition();if(!d)return null;if(c=b?b:d.node,!c)return null;for(;c&&"A"!==c.nodeName;){if("BODY"===c.nodeName){c=null;break}c=c.parentNode}return c}function h(b){var c=a.getDialog(V);return c&&b&&(c=c.getWidget(b)),c}function i(){var a={},b=h(Y),c=h(Z),d=h($),e=h(_);switch(e.index()){case 1:a.target="_self";break;case 2:a.target="_top";break;case 3:a.target="_parent";break;default:a.target="_blank"}return a.href=b.value(),a.title=d.value(),a.text=c.value(),a}function j(a){var b=h(Y),c=h(Z),d=h($),e=h(_);switch(a.target){case"_self":e.index(1);break;case"_top":e.index(2);break;case"_parent":e.index(3);break;default:e.index(0)}b.value(a.href),d.value(a.title),c.value(a.text)}function k(a){a&&j({href:a.getAttribute("href")||"",title:a.getAttribute("title")||"",target:a.getAttribute("target")||"_blank",text:a.textContent||""})}function l(a){return 1===a.length&&3===a[0].nodeType}function m(a){var b=a.cloneContents();return 11===b.nodeType&&(b=1===b.childNodes.length&&"P"===b.firstChild.nodeName?b.firstChild.childNodes:b.childNodes),b}function n(b,c){var d;b&&c&&(d=a.getDoc().createTextNode(c.text||c.href),1===b.childNodes.length&&b.removeChild(b.firstChild),b.appendChild(d))}function o(a,b){var c=b.href;a&&b&&(c.trim(),/^(http:\/\/|https:\/\/|ftp:\/\/|file:\/\/|mailto:)/.test(c)||(c="http://"+c),a.setAttribute("href",c||""),a.setAttribute("target",b.target||"_blank"),a.setAttribute("title",b.title||""))}function p(b){var c=a.getDoc(),d=c.createElement("a");return o(d,b),d}function q(a,f){var g=h(Y),i=d();S(g.element).off("keyup"),i&&(Q.selectItem(i),c(null),f&&f.button===W&&b.pressWidget(T,!0)),e(null)}function r(){var b=a.selectionManager.getSelectedBlocks();return 1===b.length}function s(b,c,d,e,f){var g,h=a.contentUtils,i=a.selectionManager;return"BODY"===c.nodeName&&(c=c.childNodes[d],d=0),"TABLE"===c.nodeName&&(g=S(c).find("td, th")[0],c=g&&g.firstChild?g.firstChild:c),h.getLeafNode(b,!0)===h.getLeafNode(c,!0)&&0===d&&(c=b),"BODY"===e.nodeName?(e=e.childNodes[0===f?0:f-1],f=3===e.nodeType?e.length:e.childNodes.length):h.getLeafNode(b,!1)===h.getLeafNode(e,!1)&&(3===e.nodeType&&e.length===f||1===e.nodeType&&e.childNodes.length===f)&&(e=b,f=b.childNodes.length),i.setRange(c,d,e,f)}function t(b,c,d,e){var f,g,h,i,j,k=a.selectionManager;return e?(g=e.startContainer,h=e.startOffset,i=e.endContainer,j=e.endOffset,1===c?f=s(d,g,h,i,j):!d.firstChild||a.contentUtils.isEmptyLine(d)?null:f=0===b?s(d,g,h,d,d.childNodes.length):b===c-1?s(d,d,0,i,j):k.setRange(d,0,d,d.childNodes.length)):null}function u(a){a&&(a.normalize(),0===a.childNodes.length&&"A"===a.nodeName&&a.parentNode.removeChild(a))}function v(a){var b,c,d=a.length||0;for(b=0;b<d;b++)c=a[b],u(c),c&&Q.unwrapChildNodes(c,"A")}function w(a){var b=a.parentNode;2===b.childNodes.length&&(b.firstChild===a&&"BR"===b.lastChild.nodeName?b.removeChild(b.lastChild):b.lastChild===a&&"BR"===b.firstChild.nodeName&&b.removeChild(b.firstChild))}function x(a){var b=a.parentNode;b&&"A"===b.nodeName&&S(a).unwrap()}function y(b,c,d,e,f){var g,h,i=a.getDoc().createTextNode(e||f),j=S(b);0===c.childNodes.length?j.append(i):(1===d&&oa&&1===c.childNodes.length&&(g=a.contentUtils.getLeafNode(c.childNodes[0],!0),h=S(g),3===g.nodeType||"BR"===g.nodeName?h.replaceWith(i):h.append(i)),j.append(c))}function z(a,b,c,d,e){a&&(y(a,b,e,d.text,d.href),c.insertNode(a),c.startContainer.normalize(),w(a),u(a.previousSibling),u(a.nextSibling),x(a))}function A(b,c,d){var e=a.selectionManager,f=e.createRange();c=1===d?b:c,c&&(f.setStartAfter(c),f.setEndAfter(c),f.collapsed=!0,e.setSingleRange(f))}function B(a,b){var c,d,e,f,g,h,i,j;for(oa=b.cellSelected?""===b.range.toString():P(b.range),d=a.length,c=0;c<d;c++)e=a[c],i=t(c,d,e,b.range),i&&(f=p(b),j=i.extractContents(),j.normalize(),v(j.childNodes),z(f,j,i,b,d),0!==c&&g?f&&(h=f):g=f);A(f,h,d)}function C(){return Q.getSelectedItem("image")}function D(){return a.pluginUtils.getSelectedCells()}function E(b,c,d){var e,f,h,i,j=c.command,k=a.getDoc(),l=a.selectionManager,m=k.getSelection();return!(!d||!d.href)&&("None"!==m.type&&0!==m.rangeCount||a.focus(),f=d.range||m.getRangeAt(0),h=d.img||C(),"insert.link"===j?h?(e=p(d),e.textContent="",S(h).wrap(e)):(i=l.getSelectedBlocks(),B(i,d)):"change.link"===j&&(e=g(h||f.startContainer),o(e,d),oa&&n(e,d)),S.isFunction(d.cb)&&d.cb.apply(),!0)}function F(b,c){var d=a.contentUtils;c.normalize(),b.setStartBefore(d.getLeafNode(c,!0))}function G(b,c){var d=a.contentUtils;c.normalize(),b.setEndAfter(d.getLeafNode(c,!1))}function H(a,b){return 1===a.nodeType&&b===a.childNodes.length||3===a.nodeType&&b===a.length}function I(a){var b=a.startContainer,c=a.endContainer;if("BODY"===a.commonAncestorContainer.nodeName||"P"===a.commonAncestorContainer.nodeName){if(a.collapsed&&b===c&&"P"===b.nodeName&&!b.childNodes.length&&0===a.startOffset)return;"P"===b.nodeName&&0===a.startOffset&&F(a,b),"P"===c.nodeName&&H(c,a.endOffset)&&G(a,c)}else"BODY"===b.nodeName&&0===a.startOffset&&F(a,b),"BODY"===c.nodeName&&a.endOffset===c.childNodes.length&&G(a,c)}function J(b,c,d){var e,f,g,h,i=d.cells,j=i.length;for(e=0;e<j;e++)f=i[e],""!==f.textContent&&(g=a.selectionManager.setRange(f,0,f,f.childNodes.length),d.range=g,d.text=g.toString(),d.cellSelected=!0,c.command="insert.link",E(null,c,d)&&(h=!0));return h}function K(b){var c,d,e,f,h,i,j,k=D();k&&k.length?(b.cells=k,a.execCommand("insert.link.cell",b)):(c=a.getDoc(),d=c.getSelection(),j=b.img||C(),e=b.range||d.getRangeAt(0),f=g(e.startContainer),h=g(e.endContainer),i=j?g(j):null,e.collapsed?f?a.execCommand("change.link",b):a.execCommand("insert.link",b):r()&&(f&&h&&f.isEqualNode(h)||i)?a.execCommand("change.link",b):a.execCommand("insert.link",b))}function L(b){var c,d,e,f,h,i,j,k=a.selectionManager;R=k.getRange().cloneRange(),a.browser.ie||S.ui.keyCode.BACKSPACE===b.keyCode&&(d=k.getRange(),f=d.startContainer,i=d.startOffset,d.collapsed&&(3===f.nodeType&&f.length===i?(c=g(f),c&&(e=a.selectionManager.getCursorPosition(),S(c.childNodes).unwrap(),a.selectionManager.setCursorPosition(e),b.preventDefault())):(j=f.childNodes.length,1===f.nodeType&&j>=i&&f.firstChild&&i>0&&(f=f.childNodes[i-1],j=f.childNodes.length,i=j),"A"===f.nodeName&&j===i&&(h=f.lastChild,S(f.childNodes).unwrap(),d=k.createRange(),d.setStartAfter(h),d.setEndAfter(h),k.setSingleRange(d),b.preventDefault()))))}function M(b){var c,d,e,f,g,h,i=0,j=R.startContainer,k=R.startOffset;if(a.browser.ie&&S.ui.keyCode.ENTER===b.keyCode&&(j===R.commonAncestorContainer&&j.nodeType===pa.NodeTypes.ELEM_NODE&&(j.nodeName===pa.NodeNames.A?d=j:j.firstChild&&j.childNodes[k>0?k-1:0].nodeName===pa.NodeNames.A&&(d=j.childNodes[k>0?k-1:0])),d&&(e=S(d).find(pa.StyleElementsStr),0===e.length&&(e=S(d).parents(pa.StyleElementsStr)),0!==e.length&&(c=a.selectionManager.getRange().cloneRange(),f=c.startContainer,c.commonAncestorContainer===f&&(f.nodeType===pa.NodeTypes.ELEM_NODE&&pa.LineBlockElements[f.nodeName]&&null===f.firstChild?h=f:f.nodeType===pa.NodeTypes.TEXT_NODE&&pa.LineBlockElements[f.parentNode.nodeName]&&(h=f.parentNode,S(h).empty())),h)))){for(i;i<e.length;i++)g=e[i].cloneNode(),h.appendChild(g),h=g;a.selectionManager.setRange(h,0,h,0)}}function N(){S(a.getBody()).on("keydown.cafe",L).on("keyup.cafe",M)}function O(b,c,d){var e,f,i=a.selectionManager.getSel(),j=h(Y),m=h(Z),n=h(W);f=i.toString()||d.toString(),e=g(b),e?(k(e),n.enable(),(!l(e.childNodes)||f&&f!==e.text)&&(m.disable(),oa=!1)):"single"===c&&m.value(f),"multi"===c&&(m.disable(),oa=!1,m.value(f),j.value(""))}function P(a){var b=m(a);return!(b&&0!==b.length&&!l(b))}var Q,R,S=a.$,T="link",U="link",V="link.dialog",W="link.dialog.ok.button",X="link.dialog.cancel.button",Y="link.dialog.input.url",Z="link.dialog.input.text",$="link.dialog.input.title",_="link.dialog.input.frame",aa=a.getText("inserthyperlink"),ba=a.getText("link.label.url"),ca=a.getText("link.label.text"),da=a.getText("link.label.title"),ea=a.getText("link.label.frame"),fa=a.getText("link.label.newwin"),ga=a.getText("link.label.currentwin"),ha=a.getText("link.label.topwin"),ia=a.getText("link.label.parentwin"),ja=a.getText("ok"),ka=a.getText("cancel"),la=a.getText("link.label.invalidalert"),ma=null,na=null,oa=!1,pa=a.constants,qa=pa.CommandTypes;a.addCommand({command:"insert.link.cell",type:qa.CUSTOM_COMMAND_BLOCK,validTags:["p"],action:J}),a.addCommand({command:"insert.link",type:qa.CUSTOM_COMMAND_BLOCK,validTags:["p"],action:E}),a.addCommand({command:"change.link",type:qa.CUSTOM_COMMAND_BLOCK,validTags:["a"],action:E}),a.addDialog(V,{title:aa,modal:!0,resizable:!1,width:400,contentOverflow:!0,items:[{type:"container",items:[{type:"textbox",name:Y,label:ba,options:{width:200,placeholder:"http://"}},{type:"textbox",name:Z,label:ca,options:{width:200}},{type:"textbox",name:$,label:da,options:{width:200}},{type:"selectmenu",name:_,label:ea,options:{width:194,autoCloseViaScroll:!1,menuItems:[{text:fa},{text:ga},{text:ha},{text:ia}]}}]}],buttons:[{name:W,text:ja,click:function(){var b=i(),c=f(),e=d(),g=h(Y);return b.range=c,b.img=e,/^(\s*)j(\s*)a(\s*)v(\s*)a(\s*)s(\s*)c(\s*)r(\s*)i(\s*)p(\s*)t(\s*):/gim.test(g.value())?void a.alert(la):(K(b),void this.close(null,W))}},{name:X,text:ka,click:function(){this.close()}}],close:q,beforeOpen:function(){var b=a.selectionManager;e(b.getRange()),c(C())},open:function(){var a,b,c,e,i,j,k,l,m,n,o=h(Y),p=h(Z),q=h($),r=h(_),s=h(W),t="";if(o.value(""),p.value(""),q.value(""),S(o.element).on("keyup",function(){o.value()?s.enable():s.disable()}),r.index(0),s.disable(),k=D(),k&&k.length){for(n=k.length,m=0;m<n;m++)l=k[m],t+=l.textContent;""===t?(oa=!0,p.enable()):(oa=!1,p.disable()),p.value(t),o.value("")}else a=f(),I(a),b=a.startContainer,c=a.endContainer,oa=P(a),oa?p.enable():p.disable(),a.collapsed?O(b,"caret",a):(e=g(b),i=g(c),(j=d())?O(j,"single",a):b.isEqualNode(c)||"A"===a.commonAncestorContainer.tagName||e&&e===i?O(b,"single",a):O(b,"multi",a))}}),a.on("selectionchange",function(c,d){var e=d.node,f=d.range;a.browser.webkit&&f.collapsed===!1&&"BODY"===e.nodeName&&"cui-wrapper"===e.childNodes[f.startOffset].className&&(d.node=Q.getSelectedItem(),d.textNodes=[],d.parents=[d.node.parentNode]),b.setWidgetState(d,T)}),a.addButton(T,{label:aa,icons:{primary:U},iconOnly:!0,click:function(){a.dialog(V)}}),a.addMenuItem(T,{icon:U,text:aa+"...",click:function(){a.dialog(V)}}),a.addContextMenuItem(T,{icon:U,text:aa+"...",context:"normal.selected image.selected",click:function(){a.dialog(V)}}),a.one("editorcreate",N),a.one("editorinitialized",function(){Q=a.pluginUtils,Q.addInitialWidgetState(T,!1,pa.ButtonTypes.TOGGLE)}),a.addFinalTask(function(){var a=h(Y);a&&S(a.element).off("keyup"),ma&&S(ma).remove(),S=null,T=null,U=null,V=null,W=null,X=null,Y=null,Z=null,$=null,_=null,aa=null,ba=null,ca=null,da=null,ea=null,fa=null,ga=null,ha=null,ia=null,ja=null,ka=null,ma=null,na=null,oa=null,pa=null,qa=null,Q=null,R=null})});