/*! cafe note v2.3.28.1 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("findreplace",[],function(a){function b(){t(a.getBody()).find(".cui-findreplace-highlight, .cui-findreplace-highlight-selected").contents().unwrap()}function c(){var b,c=t(a.getBody()).find(".cui-findreplace-highlight, .cui-findreplace-highlight-selected").last(),d=u.matchcyclic.isChecked();c.length?(b=parseInt(c.attr("cui-findreplace-index"),10),u.replaceBtn.option("disabled",!1),u.replaceAllBtn.option("disabled",!1),u.prevBtn.option("disabled",b&&!(d||q>0)),u.nextBtn.option("disabled",b&&!(d||q!==b))):(u.replaceBtn.option("disabled",!0),u.replaceAllBtn.option("disabled",!0),u.prevBtn.option("disabled",!0),u.nextBtn.option("disabled",!0))}function d(b,c){for(var d,e,f,g,h,i,j,k,l,m,n=c.shift(),o=0,p=0,q=b,r=!0,s=[],u=a.getDoc();r;){if(t.inArray(q.nodeName,C)!==-1&&p++,3===q.nodeType&&(!f&&q.length+p>=n.endIndex?(f=q,g=n.endIndex-p):d&&s.push(q),!d&&q.length+p>n.startIndex&&(d=q,e=n.startIndex-p),p+=q.length),d&&f){if(i=u.createElement("span"),i.className="cui-findreplace-highlight",i.setAttribute("cui-findreplace-index",o),i.setAttribute("data-cafe-filter","unwrap"),d===f)h=d.parentNode,e>0&&h.insertBefore(u.createTextNode(d.data.substring(0,e)),d),i.appendChild(u.createTextNode(d.data.substring(e,g))),h.insertBefore(i,d),g<d.length&&h.insertBefore(u.createTextNode(d.data.substring(g)),d),h.removeChild(d);else{for(k=0,l=s.length;k<l;++k)m=s[k],j=i.cloneNode(!1),j.appendChild(u.createTextNode(m.data)),m.parentNode.replaceChild(j,m);h=d.parentNode,h.insertBefore(u.createTextNode(d.data.substring(0,e)),d),i.appendChild(u.createTextNode(d.data.substring(e))),h.insertBefore(i,d),h.removeChild(d),h=f.parentNode,i=i.cloneNode(!1),i.appendChild(u.createTextNode(f.data.substring(0,g))),h.insertBefore(i,f),h.insertBefore(u.createTextNode(f.data.substring(g)),f),h.removeChild(f)}if(q=i,p-=f.length-g,d=f=null,s=[],n=c.shift(),o++,!n)break}else{if(q.firstChild){q=q.firstChild;continue}if(q.nextSibling){q=q.nextSibling;continue}}for(;;){if(q.nextSibling){q=q.nextSibling;break}if(q.parentNode===b){r=!1;break}q=q.parentNode}}}function e(a){var b="";if(3===a.nodeType)return a.data;if(t.inArray(a.nodeName,C)!==-1&&(b+="\n"),a=a.firstChild)do b+=e(a);while(a=a.nextSibling);return b}function f(){var f,h,i,j,k,l,n,o=[],p=u.findInput.value();if(p.length){if(s=p,f=u.matchcase.isChecked(),h=u.wholewords.isChecked(),j=a.getBody(),p=p.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),p=h?"\\b"+p+"\\b":p,r.findText===p&&r.isMatch===f&&r.isWhole===h)return void m();for(q=-1,b(),i=new RegExp(p,f?"g":"gi"),k=e(j);l=i.exec(k);)l[0]&&(n=l.index,o.push({startIndex:n,endIndex:n+l[0].length}));o.length&&(d(j,o),q=g(!0)),c(),r={findText:p,isMatch:f,isWhole:h}}}function g(b){var c,d,e=q,f=t(a.getBody()),g=u.matchcyclic.isChecked(),h=f.find(".cui-findreplace-highlight, .cui-findreplace-highlight-selected");if(!h.length)return-1;if(b?e++:e--,c=f.find(".cui-findreplace-highlight[cui-findreplace-index='"+e+"']"),c.length)return f.find(".cui-findreplace-highlight-selected").removeClass("cui-findreplace-highlight-selected").addClass("cui-findreplace-highlight"),c.removeClass("cui-findreplace-highlight").addClass("cui-findreplace-highlight-selected"),a.scrollTo(c[0]),e;if(g){if(d=parseInt(h.last().attr("cui-findreplace-index"),10),!d)return-1;q=e>0?-1:d-1,m()}return-1}function h(){var b,c,d,e,f,g,h=u.replaceInput.value(),i=t(a.getBody()),j=q;if(d=i.find(".cui-findreplace-highlight, .cui-findreplace-highlight-selected"),e=d.length,!e)return!1;for(f=0;f<e;f++)if(g=t(d[f]),b=parseInt(g.attr("cui-findreplace-index"),10),g.hasClass("cui-findreplace-highlight-selected")){if(a.lockUtils.hasLockedStyleWithParent(g[0]))continue;if(b===c){g.remove();continue}h.length?(g.text(h),g.contents().unwrap()):g.remove(),c=b,j--}else b>q&&g.attr("cui-findreplace-index",b-1);return q=j,i.find(".cui-findreplace-highlight[cui-findreplace-index='"+(q+1)+"']").length||(r={},q=-1),m(),!0}function i(){var b,d,e,f,g=u.replaceInput.value(),h=t(a.getBody()).find(".cui-findreplace-highlight, .cui-findreplace-highlight-selected"),i=h.length;if(!i)return!1;for(f=0;f<i;f++)b=t(h[f]),d=parseInt(b.attr("cui-findreplace-index"),10),a.lockUtils.hasLockedStyleWithParent(b[0])||(d!==e?(g.length?(b.text(g),b.contents().unwrap()):b.remove(),e=d):b.remove());return r={},q=-1,c(),!0}function j(){a.execCommand(v+"_replace")}function k(){a.execCommand(v+"_replaceAll")}function l(){var a=g(!1);a!==-1&&(q=a),c()}function m(){var a=g(!0);a!==-1&&(q=a),c()}function n(){a.pluginUtils.deselectItem(),a.pluginUtils.unselectAllTable(),a.dialog(v+".dialog")}function o(){var b=a.getDialog(v+".dialog");u.findInput=b.getWidget("findInput"),u.replaceInput=b.getWidget("replaceInput"),u.matchcase=b.getWidget("matchcase"),u.wholewords=b.getWidget("wholewords"),u.matchcyclic=b.getWidget("matchcyclic"),t(u.findInput.element[0]).on("keydown",function(a){a.keyCode===t.ui.keyCode.ENTER&&f()}),u.findInput.value(""),u.replaceInput.value(""),u.matchcase.option("checked",!1),u.wholewords.option("checked",!1),u.matchcyclic.option("checked",!0),u.replaceBtn=b.getWidget("replaceButton"),u.replaceAllBtn=b.getWidget("replaceAllButton"),u.prevBtn=b.getWidget("prevButton"),u.nextBtn=b.getWidget("nextButton"),u.replaceBtn.option("disabled",!0),u.replaceAllBtn.option("disabled",!0),u.prevBtn.option("disabled",!0),u.nextBtn.option("disabled",!0),r={},q=-1}function p(){var c,d,e,f,g=t(a.getBody()).find(".cui-findreplace-highlight-selected"),h=g.length;for(c=0;c<h;c++)f=g[c],d||(d=f.firstChild),e=f.firstChild;b(),t(u.findInput.element[0]).off("keydown"),a.focus(),d&&e&&a.selectionManager.setRange(d,0,e,e.data.length)}var q,r,s,t=a.$,u=this,v="findreplace",w=a.os.mac?"Command+F":"Ctrl+F",x=a.editorManager.editorConstants.CommandTypes,y=x.SYSTEM_COMMAND,z=x.CUSTOM_COMMAND_RANGE,A=a.getText(v),B=a.getText("findreplace.dialog.find"),C="META PARAM EMBED SOURCE WBR TRACK AREA BASE BASEFONT BR COL FRAME HR IMG INPUT ISINDEX LINK P H1 H2 H3 H4 H5 H6 TD TH DIV UL OL LI TABLE DL DT DD HEADER FOOTER ADDRESS PRE CENTER ARTICLE SECTION NAV".split(" ");a.addDialog(v+".dialog",{title:A,modal:!0,resizable:!0,width:"400px",items:[{type:"container",items:[{type:"textbox",name:"findInput",label:B},{type:"textbox",name:"replaceInput",label:a.getText("findreplace.dialog.replacewith")},{type:"checkbox",name:"matchcase",label:" ",options:{label:a.getText("findreplace.dialog.matchcase")}},{type:"checkbox",name:"wholewords",label:" ",options:{label:a.getText("findreplace.dialog.wholewords")}},{type:"checkbox",name:"matchcyclic",label:" ",options:{label:a.getText("findreplace.dialog.matchcyclic"),checked:!0,click:c}}]}],buttons:[{text:B,name:"findButton",float:"left",click:f},{text:a.getText("findreplace.dialog.replace"),name:"replaceButton",float:"left",click:function(){s!==u.findInput.value()?f():j()}},{text:a.getText("findreplace.dialog.replaceall"),name:"replaceAllButton",float:"left",click:function(){s!==u.findInput.value()?f():k()}},{text:a.getText("findreplace.dialog.prev"),name:"prevButton",float:"right",click:l},{text:a.getText("findreplace.dialog.next"),name:"nextButton",float:"right",click:m}],open:o,close:p}),a.addButton(v,{label:A,icons:{primary:"search-replace"},iconOnly:!0,click:n}),a.addMenuItem(v,{icon:"search-replace",text:A+"...",shortcut:w,click:n}),a.addCommand({command:v,type:y,shortcut:w,action:n}),a.addCommand({command:v+"_replace",type:z,action:h}),a.addCommand({command:v+"_replaceAll",type:z,action:i}),a.addFinalTask(function(){u.findInput&&(u.findInput.element.off("keydown"),u.findInput=null),u.replaceInput=null,u.matchcase=null,u.wholewords=null,u.matchcyclic=null,u.replaceBtn=null,u.replaceAllBtn=null,u.prevBtn=null,u.nextBtn=null,t=null,u=null,w=null,v=null,x=null,y=null,z=null,A=null,B=null,C=null,q=null,r=null,s=null})});