/*! cafe note v2.3.28.1 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("autolink",["link"],function(a){function b(a,b){var c=n.createRange();return c.setStart(a,b),c.collapse(!0),c}function c(a){return/^\s+$/.test(a)}function d(a){var b;return!!a&&(b=n.getClosest(o.getLeafNode(a,!1),"a"))}function e(a){var c,d;return d=a.childNodes,c=d[d.length-1],c="BR"===c.nodeName?c.previousSibling:c,c="SPAN"===c.nodeName&&""===c.innerHTML?c.previousSibling:c,c=o.getLeafNode(c,!1),c?b(c,3===c.nodeType?c.length:c.childNodes.length):null}function f(a){var b,c,d;return a?(d=a.cloneRange(),b=d.startContainer,b&&p.validLinkTarget(b,n.getClosest(b,v))?(c=d.startOffset-2,c<0?null:(d.setStart(b,c),d.setEnd(b,c),d=o.selectWordRange(d,!1))):null):null}function g(a,b){var c=n.getClosest(a.startContainer,v);return c?(b&&(c=c.previousSibling),c):null}function h(b,d,e){var f,g,h,i,j,k,l;return b&&d?(f=d.cloneNode(!0),s("img",f).replaceWith("&nbsp;"),g=f.textContent,e?g.length>0&&(g=d.textContent,j=g.split(x)):(h=n.getCol(d,b.startContainer,b.startOffset),i=g.substr(0,h),l=i.length,c(i.charAt(l-1))&&!c(i.charAt(l-2))&&(j=i.trim().split(x))),j?(k=j.pop().trim(),k=k?a.zwsUtils.removeZeroWidthSpaceChar(k):null,k?k:null):null):null}function i(a,b){var c=s._data(a,"events"),d=c[b],e=d.slice(d.delegateCount);e.unshift(e.pop()),Array.prototype.splice.apply(d,[d.delegateCount,e.length].concat(e))}function j(b,c,d,g,h){var i,j={href:b,text:b};i=f(g?e(d):c),i&&!a.lockUtils.isLockedSelection()&&(n.setRange(i.endContainer,i.endOffset,i.endContainer,i.endOffset),j.range=i,j.cb=function(){y&&h?a.trigger("opengraphlinkable",{keyCode:g?t.ENTER:t.SPACE,range:c}):(n.setSingleRange(c),c=null)},a.execCommand("insert.link",j))}function k(b){var c,d,e,f,g,h,i,j,k,l=q.startContainer,m=q.startOffset;if((l.nodeType!==u.NodeTypes.ELEM_NODE||l.nodeName!==u.NodeNames.SPAN||(h=l.classList,!h.contains("cui-mention")))&&(l===q.commonAncestorContainer&&l.nodeType===u.NodeTypes.ELEM_NODE?(l=l.childNodes[m>0?m-1:0],i=s(l).find(u.StyleElementsStr),0===i.length&&(i=s(l).parents(u.StyleElementsStr))):i=s(l).parents(u.StyleElementsStr),0!==i.length))if(j=b.startContainer,j.nodeType===u.NodeTypes.TEXT_NODE){if(j=j.parentNode,d=j.closest(u.NodeNames.A),d&&a.zwsUtils.isZeroWidthSpaceTextNode(b.startContainer))if(0!==s(d).parents(u.StyleElementsStr).length){for(g=i[0].cloneNode(),e=g,c=1;c<i.length;c++)f=i[c].cloneNode(),e.appendChild(f),e=f;s(d).empty(),d.replaceWith(g),a.selectionManager.setRange(g,0,g,0)}else s(d).remove()}else{for(k=j.firstChild.cloneNode(),s(j).empty(),c=0;c<i.length;c++)f=i[c].cloneNode(),j.appendChild(f),j=f;j.appendChild(k)}}function l(b){var c,e,f,i,l,m,o,v,w,x;if((t.ENTER===b.keyCode||t.SPACE===b.keyCode)&&(i=t.ENTER===b.keyCode,e=n.getRange().cloneRange(),f=g(e,i))){if(d(i?f:1===e.startOffset?e.startContainer.previousSibling:e.startContainer))return void(!a.browser.ie&&i&&k(e));if(c=h(e,f,i)){if(!p.isMatchedLinkScheme(c)){if(!q)return;return v=q.startContainer,w=q.startOffset,void(!a.browser.ie&&i&&v===q.commonAncestorContainer&&v.nodeType===u.NodeTypes.ELEM_NODE&&(o=v.childNodes[w>0?w-1:0],o.nodeType===u.NodeTypes.ELEM_NODE&&o.nodeName===u.NodeNames.A&&k(e)))}l=p.getProtocolInURL(c),l||(l=r),i&&(b.stopImmediatePropagation(),m=p.fixNewLineAfterNoneParagraph(),m&&(e=n.createRange(),e.setStart(m,0),e.setEnd(m,0),e.collapse(!0))),j(c,e,f,i,"http"===l),x=e.startContainer,!a.browser.ie&&i&&x.nodeType===u.NodeTypes.ELEM_NODE&&u.LineBlockElements[x.nodeName]&&0===s(x).find(u.StyleElementsStr).length&&k(e)}}}function m(){if(w){if(!y)return;a.getDoc().execCommand("AutoUrlDetect",!1,!1)}n=a.selectionManager,o=a.contentUtils,p=a.pluginUtils,s(a.getBody()).on("keydown.cafe",function(a){a.keyCode===t.ENTER&&(q=n.getRange().cloneRange())}).on("keyup.cafe",l),i(a.getBody(),"keyup"),r=a.getWin().location.protocol}var n,o,p,q,r,s=a.$,t=s.ui.keyCode,u=a.editorManager.editorConstants,v=u.keys(u.LineBlockElements).join(","),w=a.browser.ie,x=/\s+/,y=!1;return a.one("editorcreate",m),a.addFinalTask(function(){n=null,o=null,p=null,s=null,t=null,u=null,v=null,w=null,q=null,x=null,y=null,r=null}),{supportOpenGraph:function(b){y=b&&a.configs.enable_custom_open_graph}}});