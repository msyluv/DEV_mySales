/*! cafe note v2.3.28.1 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("lock",[],function(a){function b(a){var b=a.nodeName||a.tagName;return w[b]}function c(c,d){var e;return d&&b(d)&&d.childNodes.length>0&&(c===t?(e=a.contentUtils.getLeafNode(d,!0),e.nodeName===v.NodeNames.IMG&&(d=e)):c===u&&(e=a.contentUtils.getLeafNode(d,!1),e.nodeName===v.NodeNames.BR&&e.previousSibling?d=e.previousSibling:e.nodeName===v.NodeNames.IMG&&(d=e))),d}function d(a,b,c){if(3===b.nodeType){if(a===t&&c<b.length)return!0;if(a===u&&c>0&&c<=b.length)return!0}return!1}function e(a){for(var b,c=!0,d=a.length;d--;)if(b=a[d],"BR"!==b.nodeName){c=!1;break}return c}function f(a){var c,d;return!(!b(a)||(c=r(a.textContent)||"",0!==c.length||(d=a.children||[],0!==d.length&&!e(d))))}function g(a,b,c,d){var e;return b?(a===t?3===d.nodeType&&d.length===c||f(d)?e=b.nextSibling:1===b.nodeType&&(e=b.childNodes[c]):a===u&&(0===c?e=b.previousSibling:1===b.nodeType&&(e=b.childNodes[c-1])),e):b}function h(b){var e,f,h,i,j,k=a.selectionManager.getRange(),l=a.lockUtils;if(k.collapsed!==!0)return l.isLockedSelection();h=k.startOffset,i=k.startContainer,e=k.commonAncestorContainer;do{if(d(b,e,h))return!!l.hasLockedStyleWithParent(i);if(f=g(b,e,h,i),f=c(b,f),j=e.parentNode.lastChild,b===t&&f&&j&&"BR"===j.nodeName&&"BR"===f.nodeName&&(f=null),f)break;e=e.parentNode}while("BODY"!==e.nodeName);return!!l.hasLockedStyleWithParent(f)}function i(a){switch(a.keyCode){case s.LEFT:case s.RIGHT:case s.UP:case s.DOWN:case s.HOME:case s.END:case s.PAGE_DOWN:case s.PAGE_UP:return!0;default:return!1}}function j(a){var b=a.keyCode,c=a.metaKey||a.ctrlKey;return c&&67===b}function k(a){var b=a.keyCode,c=a.metaKey||a.ctrlKey;return c&&65===b}function l(a){a.preventDefault(),a.stopImmediatePropagation()}function m(a,b){return!(a.nodeType!==v.NodeTypes.TEXT_NODE||a.parentNode.nodeName!==v.NodeNames.SPAN||!a.previousSibling||a.previousSibling.nodeName!==v.NodeNames.IMG)||!(a.nodeType!==v.NodeTypes.ELEM_NODE||a.nodeName!==v.NodeNames.SPAN||!a.childNodes.length||!a.childNodes[b>0?b-1:b].previousSibling||a.childNodes[b>0?b-1:b].previousSibling.nodeName!==v.NodeNames.IMG)}function n(b,c){var d,e,f,g,h,i,j,k,l,m,n=b.parentNode,o=b.parentNode.cloneNode(),p=o.cloneNode(),r=n.childNodes,s=b.childNodes.length,t=a.selectionManager.getRange().cloneRange();for(e=0;e<r.length;e++)b===r[e]&&(g=e);for(e=0;e<s;e++)i=b.childNodes[e],j=q(i).clone(),i.nodeName===v.NodeNames.IMG?p.appendChild(j[0]):(c===i&&(f=e),h=b.cloneNode(),h.appendChild(j[0]),p.appendChild(h));for(e=0;e<r.length;e++)if(e===g)for(d=0;d<p.childNodes.length;d++)o.appendChild(p.childNodes[d].cloneNode(!0));else o.appendChild(r[e].cloneNode(!0));n.replaceWith(o),k=o.childNodes[g+f].firstChild,t.collapsed?(l=k,m=0):(l=t.endContainer,m=t.endOffset),a.selectionManager.setRange(k,0,l,m)}function o(b){var c,d,e=a.selectionManager.getRange(),f=e.startContainer,g=e.startOffset;if(m(f,g)&&(f.nodeType===v.NodeTypes.ELEM_NODE?(c=f,d=f.childNodes[g]):(c=f.parentNode,d=f),n(c,d)),b.keyCode===t||b.keyCode===u){if(h(b.keyCode))return l(b),a.selectionManager.getSel().removeAllRanges(),!1}else if(!k(b)&&!j(b)&&!i(b)&&a.lockUtils.isLockedSelection(!0))return a.selectionManager.getSel().removeAllRanges(),!1}function p(){a.lockUtils.isLockedSelection(!0)&&a.selectionManager.getSel().removeAllRanges()}var q=a.$,r=q.trim,s=q.ui.keyCode,t=s.DELETE,u=s.BACKSPACE,v=a.constants,w={P:!0,H1:!0,H2:!0,H3:!0,H4:!0,H5:!0,H6:!0,LI:!0};a.one("editareacreate",function(){var b,c=a.lockUtils,d=a.selectionManager;q(a.getBody()).on("mousedown.cafe",function(a){if(c.hasLockedStyleWithParent(a.target))return l(a),!1}).on("keydown.cafe",o).on("compositionstart.cafe",p).on("contextmenu.cafe","[data-cui-lock='true']",function(b){if(c.hasLockedStyleWithParent(b.target))return a.uiManager.closeContextMenu(),l(b),!1}),q(a.getDoc()).on("drop ondrop",function(e){if(b=d.getRangeFromEvent(e.originalEvent),a.browser.ie&&d.setSingleRange(b),c.hasLockedStyleWithParent(b?b.startContainer:null))return l(e),!1})}),a.addFinalTask(function(){w=null,t=null,u=null,s=null,r=null,q=null})});