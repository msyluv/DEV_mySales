/*! cafe note v2.3.27 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("dragdrop",[],function(a){function b(b,c){if(a.configs.enable_image_size_alert&&b.size>3145728)return void g(!0);if(window.FileReader){var e=new window.FileReader;e.onload=function(b){a.pluginUtils.setActionDataForImageFormatQuality({from:"dragdrop",callback:d,result:b.target.result,range:c}),a.dialog("imageformatquality"),a.getDialog("imageformatquality").options.imageData=b.target.result},e.readAsDataURL(b)}}function c(a,b){var c;t&&window.FormData&&(c=new window.FormData,c.append("file",a),q.ajax({url:t,type:"POST",data:c,processData:!1,contentType:!1,success:function(a){d(a,b)},error:function(){console.log("file upload failed")}}))}function d(b,c,d){var e=a.getDoc().createElement("img");q(e).load(function(){d&&(e=a.pluginUtils.convertImage(e,b)),c||(c=a.selectionManager.getRange()),a.contentUtils.insertElementByRange(e,c),a.trigger("documentchanged"),q(e).off("load error"),e=null}).error(function(){g(),q(e).off("load error").remove(),e=null}),e.setAttribute("src",b),e.setAttribute("unselectable","on"),e.setAttribute("data-cui-image","true"),e.style.borderWidth="0px"}function e(a,d){s?b(a,d):c(a,d)}function f(a){return a&&q.inArray("Files",a.types)!==-1}function g(b){var c=b?a.getText("dragdrop.notsupportfilesize"):a.getText("dragdrop.notsupportfiletype");a.alert(c),a.one("alertclose",function(){a.focus()})}function h(a){var b,c=u.length;for(b=0;b<c;b++)if(u[b](a)===!0)return!0;return!1}function i(a){return u.push(a)}function j(b,c){var d,e=a.selectionManager;return!a.browser.ie&&(d=b.getData("text/html"))?(e.setSingleRange(c),void a.execCommand("pasteashtml",{range:c,contents:{"text/html":d}})):(d=b.getData("text"),void(d&&(d=d.replace(/\r\n/g,"\n"),e.setSingleRange(c),a.execCommand("pasteastext",{range:c,contents:d}))))}function k(b){var c,d,i,k,l,m,n,o=b.originalEvent,r=o.dataTransfer,s=a.constants.LineBlockElements,t=a.selectionManager;if(r){if(k=r.getData("text"),k&&k.indexOf("caferes")!==-1&&(l=a.pluginUtils.getSelectedItem(),l&&"absolute"===l.style.position&&(l.style.top="",l.style.left="",l.style.marginTop="",l.style.marginLeft="",m=l.parentNode,m&&"DIV"===m.nodeName&&(n=m,m.style.top="",m.style.left="",m.style.marginTop="",m.style.marginLeft="",m=m.parentNode),m&&a.browser.webkit&&n))){for(;!s[m.nodeName]&&"BODY"!==m.nodeName;)m=m.parentNode;m.parentNode.insertBefore(l,m),q(n).remove()}return p?void(p=!1):void(k&&k.indexOf("caferes")!==-1||(o.preventDefault(),f(r)?(c=r.files,c&&c.length>0&&(d=c[0].type,d||(d=c[0].name,d=d.substring(d.lastIndexOf(".")+1,d.length)),h(d)?a.pluginUtils.isAllowedImageDataType(d)&&(i=t.getRangeFromEvent(o),e(c[0],i)):g())):(i=t.getRangeFromEvent(o),j(r,i))))}}function l(b){var c,d=b.originalEvent,e=a.browser,g=a.selectionManager;p||d.dataTransfer&&f(d.dataTransfer)&&(e.ie?d.preventDefault():(c=g.getRangeFromEvent(d),c&&c.commonAncestorContainer&&1===c.commonAncestorContainer.nodeType&&3!==c.startContainer.nodeType&&d.preventDefault()),a.getWin().clearTimeout(o),o=a.getWin().setTimeout(function(){a.uiManager.isAlertOpened()||(a.pluginUtils.deselectItem(),c=g.getRangeFromEvent(d),c&&!c.select&&g.setSingleRange(c),a.focus())},0))}function m(){return!a.lockUtils.isLockedSelection(!0)&&void(p=!0)}function n(){p=!1}var o,p,q=a.$,r=a.configs,s=void 0===r.image_embedded||!!r.image_embedded,t=r.image_upload,u=[],v=a.getSupportImageType();return a.one("editorcreate",function(){q(a.getDoc()).on("drop",k).on("dragover",l).on("dragstart",m).on("dragend",n),i(a.pluginUtils.isAllowedImageDataType)}),a.addFinalTask(function(){q=null,o=null,p=null,r=null,s=null,t=null,u=null,v=null}),{isExternalFile:f,addCheckSupportTypeFn:i}});