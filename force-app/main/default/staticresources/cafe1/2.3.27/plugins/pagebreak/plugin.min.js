/*! cafe note v2.3.27 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("pagebreak",[],function(a){function b(){var b=a.getDoc().createElement("span");return b.style.border="1px dotted",b.style.height="2px",b.style.width="99%",b.style.display="block",b.style.position="relative",b.style.top="50%",b.style.transform="translateY(-50%)",b.style.pageBreakBefore="always",b.setAttribute("unselectable","on"),b.setAttribute("data-cui-pagebreak",!0),b.setAttribute("data-cafe-filter","pagebreak"),b.contentEditable=!1,b.tabIndex="-1",b.innerHTML="&#65279;",b}function c(a){n(a).append("<br>").append(b())}function d(){var b,d,e,f,g,h=a.contentUtils,i=a.selectionManager,j=a.pluginUtils;return a.isFocused()&&a.focus(),a.pluginUtils.unselectAllTable(),b=i.getRange(),f=j.getSelectedItem(),b.collapsed||(f?(j.deselectItem(),n(f).remove()):a.getDoc().execCommand("Delete",!1,null),b=i.getRange()),h.splitLineByRange(b,function(a,b){d=a,e=b}),d&&(h.isEmptyLine(d)&&(g=d.lastChild,g&&n(g).remove()),c(d)),e&&i.setRange(e,0,e,0),!0}function e(b){var c,d;b&&(c=b.nextSibling,c&&(a.contentUtils.isEmptyLine(c)&&n(c).remove(),b.lastChild&&"BR"===b.lastChild.nodeName&&(d=b.childNodes.length-1,a.selectionManager.setRange(b,d,b,d))))}function f(a){return!(!a||"SPAN"!==a.nodeName||!a.getAttribute("data-cui-pagebreak"))}function g(b,c){var d,g,h;if(3===b.nodeType&&a.zwsUtils.isZeroWidthSpaceChar(b.nodeValue)&&(b=b.parentNode),"P"===b.nodeName&&c===n.ui.keyCode.BACKSPACE&&(b=b.lastChild),d=n(b),f(b))return c===n.ui.keyCode.BACKSPACE&&(h=b.previousSibling,h&&"BR"===h.nodeName&&n(h).remove()),g=b.parentNode,d.remove(),e(g),!0}function h(b){var c;a.browser.ie&&b.which&&(c=a.selectionManager.getRange(),c&&c.collapsed&&c.startContainer&&f(c.startContainer.parentNode)&&b.preventDefault())}function i(b){var c,d=a.selectionManager;!a.browser.ie||b.keyCode!==n.ui.keyCode.BACKSPACE&&b.keyCode!==n.ui.keyCode.DELETE||(c=d.getRange(),c.collapsed&&g(c.startContainer,b.keyCode)&&a.trigger("documentchanged"))}function j(b){var c,d,e;if(b.table&&"TABLE"===b.table.nodeName)return void a.disableMenuItem(l,!0);for(e=b.parents,d=e.length,c=0;c<d;c++)if("TD"===e[c].nodeName||"TR"===e[c].nodeName||"TABLE"===e[c].nodeName)return void a.disableMenuItem(l,!0);a.disableMenuItem(l,!1)}function k(a,b){var c,d,e,f;if("edit"!==p&&"public"!==b)for(e=n(a).find("span[data-cui-pagebreak]"),f=e.length,c=0;c<f;c++)d=n(e[c]),"preview"===p?d.css("visibility","hidden"):"codeview"===p&&d.attr("data-cafe-filter",null)}var l="pagebreak",m="page-break",n=a.$,o=a.getText(l),p="edit";a.on("tabsbeforeactivate",function(a,b){p=b.newPanelName}),a.one("editorcreate",function(){a.selectionManager.addGetFilter("pagebreak",null,k),n(a.getBody()).on("keyup.cafe",i).on("keypress.cafe",h)}),a.on("selectionchange",function(b,c){a.pluginUtils.isCharKeyCode(c.keyCode)||j(c)}),a.on("tableinsert",function(a,b){j(b)}),a.addButton(l,{label:o,icons:{primary:m},iconOnly:!0,click:function(){a.pluginUtils.deselectItem(),a.execCommand(l)}}),a.addMenuItem(l,{icon:m,text:o,click:function(){a.pluginUtils.deselectItem(),a.execCommand(l)}}),a.addCommand({command:l,type:cafe.editorConstants.CommandTypes.CUSTOM_COMMAND_BLOCK,tag:"p",action:d}),a.addFinalTask(function(){l=null,m=null,n=null,o=null,p=null})});