/*! cafe note v2.3.27 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("exmhtmlloader",["mhtmlloader"],function(a,b){function c(a,c){var e,f,h,i,j,m,n,o,p,q,r,t,u,w;if(s){if(e=v("img",s),e&&e.length>0)for(j=e.length,m=0;m<j;m++)f=e[m],q=d(f),f.getAttribute("data-cui-media")||(r=g(q,a?null:f),t=b.makeContentID(r),r&&t&&b.replaceImageToCID(t,f));if(c){if(h=v("[style*='background']",s),h&&h.length>0)for(j=h.length,m=0;m<j;m++)for(i=h[m],u=i.getAttribute("style"),o=u.match(/background[^)]*\)/g),p=o?o.length:0,n=0;n<p;n++)q=/url[('"]+([^'")]*)['")]+/g.exec(o[n]),q&&q.length>1&&(q=q[1],r=g(d(null,q)),t=b.makeContentID(r),r&&t&&(w=u.replace(r,t),k(w,i)));if(h=v("[background]",s),h&&h.length>0)for(j=h.length,m=0;m<j;m++)i=h[m],q=i.getAttribute("background"),r=g(d(null,q)),t=b.makeContentID(r),r&&t&&l(t,i)}}}function d(a,b){var c,d;return a?c=a.getAttribute("src"):(d=b.substr(0,11),c="data:image/"===d||/https?:\/\//g.test(d)||"cid:"===d.substr(0,4)?b:e(b)),c}function e(b){var c=b.substr(0,11);return"data:image/"===c||/https?:\/\//g.test(c)||"cid:"===c.substr(0,4)?b:(t||(t=a.getDoc().createElement("a")),t.setAttribute("href",b),t.href)}function f(b){var c,d,e,f;c=a.getWin(),d=c?c.location.protocol:null,e=c?c.location.hostname:null,f=c?c.location.port:null;try{if(d&&e&&b&&(f||""===f)&&(t||(t=a.getDoc().createElement("a")),t.setAttribute("href",b),t.protocol===d&&t.hostname===e&&(t.port===f||("80"===t.port||"443"===t.port)&&""===f)))return!0}catch(a){return!1}return!1}function g(b,c){var d;return/^data:image\//i.test(b)?d=b:a.pluginUtils.checkImageSource(b)&&f(b)?(d=y[b])||(c?d=h(c):x&&z.indexOf(b)<0&&z.push(b)):d=b,d}function h(b){var c,e,f,g,h,i,j;try{q&&r||(q=document.createElement("canvas"),r=q.getContext("2d")),c=b.naturalWidth,e=b.naturalHeight,f=d(b),c>0&&e>0&&(q.width=c,q.height=e,r.drawImage(b,0,0,c,e),g=f.indexOf("?"),g<0&&f.indexOf(a.getResourcesUrl())>=0&&(g=f.length),h=f.lastIndexOf(".",g)+1,g>0&&h>0&&g-h<5&&(i=f.slice(h,g).toLowerCase(),"png"!==i&&"gif"!==i||(j=q.toDataURL("image/png"))),j||(j=q.toDataURL("image/jpeg",100))),y[f]=j}catch(a){q=document.createElement("canvas"),r=q.getContext("2d")}return j}function i(){var b,c,d;if(z&&z.length>0){for(c=z.length,b=0;b<c;b++)d=a.getDoc().createElement("img"),d.onload=j,d.onerror=j,d.src=z[b];return!0}return!1}function j(a){var c,d;A.push(this.src),a&&"load"===a.type&&(c=h(this),d=b.makeContentID(c),d&&m(d,this.src)),z.length===A.length&&(u(b.encodeMHTMLWithBody(s,"public")),o(null))}function k(a,b){b&&b.setAttribute("style",a)}function l(a,b){b.removeAttribute("background"),b.setAttribute("data-cui-bg-cid",a)}function m(a,b){var c,e,f,g,h,i,j,k,l,m,o,p;if(f=v("[style*='background']",s),f&&f.length>0)for(i=f.length,l=0;l<i;l++)for(g=f[l],o=g.getAttribute("style"),j=o.match(/background[^)]*\)/g),k=j?j.length:0,m=0;m<k;m++)h=/url[('"]+([^'")]*)['")]+/g.exec(j[m]),h&&h.length>1&&(h=h[1],h&&n(d(null,h),b)&&(p=o.replace(h,a),g.setAttribute("style",p)));if(f=v("[background]",s),f&&f.length>0)for(i=f.length,l=0;l<i;l++)g=f[l],h=g.getAttribute("background"),n(d(null,h),b)&&(g.removeAttribute("background"),g.setAttribute("data-cui-bg-cid",a));if(c=v("img",s),c&&c.length>0)for(i=c.length,l=0;l<i;l++)e=c[l],n(d(e),b)&&(e.removeAttribute("src"),e.setAttribute("data-cui-image-cid",a))}function n(b,c){var d;if(b&&c){if(d=b.substr(0,11),"data:image/"===d||"cid:"===d.substr(0,4))return b===c;if(!a.pluginUtils.checkImageSource(b)||!f(b))return!1;try{return decodeURI(b)===decodeURI(c)}catch(a){}}return!1}function o(c){b.initEncode(!0),s=v(a.getBody()).clone(),y=[],z=[],A=[],u=c}function p(a){return(!a||"function"==typeof a&&z.length===A.length)&&(o(a),!!a&&(c(!0,!0),i()||setTimeout(function(){u(b.encodeMHTMLWithBody(s,"public")),o(null)},0),!0))}var q,r,s,t,u,v=a.$,w=a.editorManager,x=a.configs.mhtml_convert_data_uri,y=[],z=[],A=[];a.encodeMHTMLFromEditorEx=function(a){return p(a)},"function"!=typeof w.encodeMHTMLFromEditorEx&&(w.encodeMHTMLFromEditorEx=function(a,b){var c;return!(!a||!b)&&(c=this.get(a),!(!c||!c.encodeMHTMLFromEditorEx||c.pluginUtils.isTextMode())&&(c.execCommand("codeview.updatecontent"),c.encodeMHTMLFromEditorEx(b)))}),a.addFinalTask(function(){t&&v(t).remove(),s&&s.remove(),q&&v(q).remove(),v=null,w=null,x=null,r=null,q=null,s=null,t=null,y=null,z=null,A=null,u=null})});