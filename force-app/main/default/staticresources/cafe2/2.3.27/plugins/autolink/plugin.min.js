/*! cafe note v2.3.27 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("autolink",["link"],function(a){function b(a,b){var c=n.createRange();return c.setStart(a,b),c.collapse(!0),c}function c(a){return/^\s+$/.test(a)}function d(a){var b;return!!a&&(b=n.getClosest(o.getLeafNode(a,!1),"a"))}function e(a){var c,d;return d=a.childNodes,c=d[d.length-1],c="BR"===c.nodeName?c.previousSibling:c,c="SPAN"===c.nodeName&&""===c.innerHTML?c.previousSibling:c,c=o.getLeafNode(c,!1),c?b(c,3===c.nodeType?c.length:c.childNodes.length):null}function f(a){var b,c,d;return a?(d=a.cloneRange(),b=d.startContainer,b&&p.validLinkTarget(b,n.getClosest(b,u))?(c=d.startOffset-2,c<0?null:(d.setStart(b,c),d.setEnd(b,c),d=o.selectWordRange(d,!1))):null):null}function g(a,b){var c=n.getClosest(a.startContainer,u);return c?(b&&(c=c.previousSibling),c):null}function h(b,d,e){var f,g,h,i,j,k,l;return b&&d?(f=d.cloneNode(!0),r("img",f).replaceWith("&nbsp;"),g=f.textContent,e?g.length>0&&(g=d.textContent,j=g.split(w)):(h=n.getCol(d,b.startContainer,b.startOffset),i=g.substr(0,h),l=i.length,c(i.charAt(l-1))&&!c(i.charAt(l-2))&&(j=i.trim().split(w))),j?(k=j.pop().trim(),k=k?a.zwsUtils.removeZeroWidthSpaceChar(k):null,k?k:null):null):null}function i(a,b){var c=r._data(a,"events"),d=c[b],e=d.slice(d.delegateCount);e.unshift(e.pop()),Array.prototype.splice.apply(d,[d.delegateCount,e.length].concat(e))}function j(b,c,d,g,h){var i,j={href:b,text:b};i=f(g?e(d):c),i&&!a.lockUtils.isLockedSelection()&&(n.setRange(i.endContainer,i.endOffset,i.endContainer,i.endOffset),j.range=i,j.cb=function(){x&&h?a.trigger("opengraphlinkable",{keyCode:g?s.ENTER:s.SPACE,range:c}):(n.setSingleRange(c),c=null)},a.execCommand("insert.link",j))}function k(b){var c,d,e,f,g,h,i,j,k,l=q.startContainer,m=q.startOffset;if((l.nodeType!==t.NodeTypes.ELEM_NODE||l.nodeName!==t.NodeNames.SPAN||(h=l.classList,!h.contains("cui-mention")))&&(l===q.commonAncestorContainer&&l.nodeType===t.NodeTypes.ELEM_NODE?(l=l.childNodes[m>0?m-1:0],i=r(l).find(t.StyleElementsStr),0===i.length&&(i=r(l).parents(t.StyleElementsStr))):i=r(l).parents(t.StyleElementsStr),0!==i.length))if(j=b.startContainer,j.nodeType===t.NodeTypes.TEXT_NODE){if(j=j.parentNode,d=j.closest(t.NodeNames.A),d&&a.zwsUtils.isZeroWidthSpaceTextNode(b.startContainer))if(0!==r(d).parents(t.StyleElementsStr).length){for(g=i[0].cloneNode(),e=g,c=1;c<i.length;c++)f=i[c].cloneNode(),e.appendChild(f),e=f;r(d).empty(),d.replaceWith(g),a.selectionManager.setRange(g,0,g,0)}else r(d).remove()}else{for(k=j.firstChild.cloneNode(),r(j).empty(),c=0;c<i.length;c++)f=i[c].cloneNode(),j.appendChild(f),j=f;j.appendChild(k)}}function l(b){var c,e,f,i,l,m,o,u,v,w;if((s.ENTER===b.keyCode||s.SPACE===b.keyCode)&&(i=s.ENTER===b.keyCode,e=n.getRange().cloneRange(),f=g(e,i))){if(d(i?f:1===e.startOffset?e.startContainer.previousSibling:e.startContainer))return void(!a.browser.ie&&i&&k(e));if(c=h(e,f,i)){if(!p.isMatchedLinkScheme(c)){if(!q)return;return u=q.startContainer,v=q.startOffset,void(!a.browser.ie&&i&&u===q.commonAncestorContainer&&u.nodeType===t.NodeTypes.ELEM_NODE&&(o=u.childNodes[v>0?v-1:0],o.nodeType===t.NodeTypes.ELEM_NODE&&o.nodeName===t.NodeNames.A&&k(e)))}l=p.getProtocolInURL(c),l&&(i&&(b.stopImmediatePropagation(),m=p.fixNewLineAfterNoneParagraph(),m&&(e=n.createRange(),e.setStart(m,0),e.setEnd(m,0),e.collapse(!0))),j(c,e,f,i,"http"===l),w=e.startContainer,!a.browser.ie&&i&&w.nodeType===t.NodeTypes.ELEM_NODE&&t.LineBlockElements[w.nodeName]&&0===r(w).find(t.StyleElementsStr).length&&k(e))}}}function m(){if(v){if(!x)return;a.getDoc().execCommand("AutoUrlDetect",!1,!1)}n=a.selectionManager,o=a.contentUtils,p=a.pluginUtils,r(a.getBody()).on("keydown.cafe",function(a){a.keyCode===s.ENTER&&(q=n.getRange().cloneRange())}).on("keyup.cafe",l),i(a.getBody(),"keyup")}var n,o,p,q,r=a.$,s=r.ui.keyCode,t=a.editorManager.editorConstants,u=t.keys(t.LineBlockElements).join(","),v=a.browser.ie,w=/\s+/,x=!1;return a.one("editorcreate",m),a.addFinalTask(function(){n=null,o=null,p=null,r=null,s=null,t=null,u=null,v=null,q=null,w=null,x=null}),{supportOpenGraph:function(b){x=b&&a.configs.enable_custom_open_graph}}});