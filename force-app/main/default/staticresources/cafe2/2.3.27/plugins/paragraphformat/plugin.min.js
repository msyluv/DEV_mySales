/*! cafe note v2.3.27 | Copyright 2014, S-Core, Inc. All Right Reserved. */
cafe.pluginManager.add("paragraphformat",[],function(a){function b(b,c){var g,h,i,j,k,l,m=!1,n=a.selectionManager;if(b&&c){for(c=c.toUpperCase(),k=n.getRange(),t={startContainer:k.startContainer,startOffset:k.startOffset,endContainer:k.endContainer,endOffset:k.endOffset,collapsed:k.collapsed},g=0,h=b.length;g<h;g++)if(i=b[g],j=i.nodeName,x.inArray(j,A)!==-1)if("LI"===j){if("P"===c)continue;m=d(i,c),t.startContainer===i&&(t.startContainer=i.firstChild,t.endContainer=i.firstChild)}else{if(j===c)continue;if("P"===c&&"LI"===i.parentNode.nodeName){m=e(i);continue}m=f(i,c)}m&&(l=n.getRange(),t.startContainer!==l.startContainer&&(t={startContainer:l.startContainer,startOffset:l.startOffset,endContainer:l.endContainer,endOffset:l.endOffset,collapsed:l.collapsed}),n.setRange(t.startContainer,t.startOffset,t.endContainer,t.endOffset),a.selectionChange.contentChanged())}}function c(c,d,e){var f,g,h,i,j,k,l=a.selectionManager;if(e){if(a.pluginUtils.fillEmptyCellsInRange(l.getRange(),e),i=a.pluginUtils.getSelectedCells(),i&&i.length){for(j=l.getCursorPosition(),g=i.length,f=0;f<g;f++)h=i[f],k=x.makeArray(h.childNodes),b(k,e);j=j?{node:a.contentUtils.getLeafNode(i[0],!0),line:j.line,offset:0}:null}else b(c,e);return j&&l.setCursorPosition(j),!0}}function d(a,b){return x(a).wrapInner("<"+b+"></"+b+">"),g(a,a.firstChild),!0}function e(a){return g(a,a.parentNode),x(a).contents().unwrap(),!0}function f(b,c){var d=a.getDoc(),e=d.createElement(c);for(g(b,e),t.startContainer===b&&(t.startContainer=e),t.endContainer===b&&(t.endContainer=e);b.childNodes.length>0;)e.appendChild(b.childNodes[0]);return a.browser.ie&&0===e.childNodes.length&&(e.textContent="Â "),b.parentNode.replaceChild(e,b),!0}function g(a,b){var c,d,e=a.attributes;for(c=e.length-1;c>=0;c--)d=e[c],b.setAttribute(d.name,d.value),a.removeAttribute(d.name)}function h(){var b,c,d,e,f=[],g=y.length;for(b=0;b<g;b++)c=y[b],d=i(c),e=v+c,a.addMenuItem(e,d),f.push(e);return f}function i(b){return{text:"<"+b+">"+a.getText(v+"."+b)+"</"+b+">",click:function(){a.pluginUtils.deselectItem(),a.execCommand(v,b)}}}function j(){return u||(u=a.getToolButton(v)),u}function k(b){var c,d,e,f,g=null;for(e=0,f=b.length;e<f;e++)if(c=b[e],!(3!==c.nodeType&&"BR"!==c.nodeName||3===c.nodeType&&""===c.data)&&(d=l(a.selectionManager.getAncestors(c)))&&(g||(g=d),g!==d))return null;return g}function l(a){var b,c,d,e;for(b=0,c=a.length;b<c;b++)if(d=a[b],1===d.nodeType&&(e=d.nodeName,x.inArray(e,A)!==-1))return"DIV"!==e&&"LI"!==e||(e="P"),e;return null}function m(b){var c,d,e,f,g=j();for(b=b||"",b=b.toLowerCase(),g&&(b?(c=y.indexOf(b),g.index(c),b.indexOf("h")!==-1&&g.option("label",b.toUpperCase())):g.option("label",w)),e=0,f=y.length;e<f;e++)d=y[e],a.toggleMenuItem(v+d,d===b)}function n(a,b){var c,d,e;if(!a)return null;for(d=a,e=b?"previousSibling":"nextSibling",c=a[e];!c&&"BODY"!==d.nodeName;)d=d.parentNode,c=d[e];return c}function o(b){var c,d,e,f,g,h,i={P:!0,H1:!0,H2:!0,H3:!0,H4:!0,H5:!0,H6:!0,LI:!0};if(b){if(c=n(b,!0),!c)return!0;if(/^UL|OL$/i.test(c.nodeName))for(;c&&"LI"!==c.nodeName;)c=c.lastChild;if(c&&i[c.nodeName])return d=a.contentUtils.getLeafNode(c,!1),e=c.childNodes.length,x(c).append(b.childNodes),g=b.parentNode,h=a.contentUtils.getLeafNode(c.childNodes[e],!0),x(b).remove(),"LI"!==g.nodeName||g.childNodes.length||x(g).remove(),!!h&&(f=3===d.nodeType?d.length:d.childNodes.length,d.nodeName===z.NodeNames.BR?(h.nodeName===z.NodeNames.BR&&(h=h.parentNode),f=0,d.parentNode.removeChild(d)):h=d,a.contentUtils.trimEmptyTextElem(c.firstChild),a.contentUtils.trimEmptyTextElem(c.lastChild),h.nodeName!==c.nodeName&&a.selectionManager.setRange(h,f,h,f),!1)}return!0}function p(b){var c,d,e,f,g,h=!1;if(c=a.selectionManager.getRange(),C.BACKSPACE===b){if(c.collapsed&&0===c.startOffset&&0===c.endOffset&&(d=c.startContainer,g=x(d).closest(z.LineElementsStr)[0],g&&a.contentUtils.getLeafNode(g,!0)===d))return g}else if(C.DELETE===b&&(d=c.startContainer,d.nodeType===z.NodeTypes.TEXT_NODE?e=d.length:(e=d.childNodes.length,1===e&&d.firstChild.nodeName===z.NodeNames.BR&&(e=0,h=!0)),c.collapsed&&c.startOffset===e&&c.endOffset===e&&(f=x(d).closest(z.LineElementsStr)[0],g=n(f,!1),g&&(a.contentUtils.getLeafNode(f,!1)===d||h)&&("LI"===g.nodeName&&"LI"===f.nodeName&&(g=g.firstChild),A.indexOf(g.nodeName)!==-1))))return g;return null}function q(b){var c;x.ui.keyCode.ENTER===b.keyCode&&(c=a.pluginUtils.fixNewLineAfterNoneParagraph(),c&&(a.selectionManager.setRange(c,0,c,0),a.selectionChange.contentChanged()))}function r(b){var c=b.keyCode;if(!a.browser.ie&&(C.BACKSPACE===c||C.DELETE===c))return o(p(c))}var s,t,u,v="paragraphformat",w=a.getText(v),x=a.$,y=["p","h1","h2","h3","h4","h5","h6"],z=a.constants,A=z.LineElementsArr,B=z.CommandTypes.CUSTOM_COMMAND_BLOCK,C=x.ui.keyCode;s=h(),a.addButton(v,{widgetType:"selectmenu",label:w,menuItems:s,width:100,maxHeight:350,tooltip:w,autoCloseViaScroll:!1}),a.addMenuItem(v,{text:w,menuItems:s}),a.addCommand({command:v,type:B,action:c}),a.on("selectionchange",function(b,c){var d,e=c.parents,f=c.textNodes;a.pluginUtils.isCharKeyCode(c.keyCode)||(d=f.length?k(f):l(e),m(d))}),a.one("editorcreate",function(){var b=a.pluginUtils;b.addInitialWidgetState(v,-1,a.constants.ButtonTypes.MENU),x(a.getBody()).on("keyup.cafe",q).on("keydown.cafe",r)}),a.addFinalTask(function(){v=null,w=null,s=null,t=null,C=null,x=null,u=null,y=null,A=null,z=null,B=null})});